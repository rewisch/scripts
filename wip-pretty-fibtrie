#!/usr/bin/env bash

ESC=$'\033'
RESET="${ESC}[0m"
BOLD="${ESC}[1m"

GREEN="${ESC}[32m"
CYAN="${ESC}[36m"
YELLOW="${ESC}[33m"
BLUE="${ESC}[34m"
MAGENTA="${ESC}[35m"
RED="${ESC}[31m"

awk -v RESET="$RESET" -v BOLD="$BOLD" \
  -v GREEN="$GREEN" -v CYAN="$CYAN" -v YELLOW="$YELLOW" \
  -v BLUE="$BLUE" -v MAGENTA="$MAGENTA" -v RED="$RED" '
function colorize(line) {
    gsub(/([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(\/[0-9]+)?)/,
         CYAN "&" RESET, line)

    gsub(/\bhost\b/, MAGENTA "host" RESET, line)
    gsub(/\blink\b/, BLUE "link" RESET, line)
    gsub(/\buniverse\b/, YELLOW "universe" RESET, line)

    gsub(/\bUNICAST\b/, GREEN "UNICAST" RESET, line)
    gsub(/\bLOCAL\b/, GREEN "LOCAL" RESET, line)
    gsub(/\bBROADCAST\b/, RED "BROADCAST" RESET, line)

    return line
}

# Count leading spaces
function indent_level(s) {
    match(s, /^ */)
    return RLENGTH
}

{
    raw = $0
    if (raw ~ /^Main:|^Local:/) {
        print BOLD raw RESET
        next
    }

    # Ignore empty lines
    if (raw ~ /^[[:space:]]*$/) next

    lvl = indent_level(raw)
    text = raw
    sub(/^ */, "", text)

    # Each 2 spaces = one tree level (empirically correct for fib_trie)
    depth = int(lvl / 2)

    # Determine branch type
    for (i = 0; i < depth - 1; i++) {
        printf (open[i] ? "│   " : "    ")
    }

    # Peek ahead: assume more children unless indentation decreases later
    # Default to continuing branch
    branch = "├── "

    # Record this level as open
    open[depth] = 1

    printf "%s%s\n", branch, colorize(text)
}
' /proc/net/fib_trie

# Legend
printf "\n%b\n" "${BOLD}Legend:${RESET}"
printf "  %b        Network or host address\n" "${CYAN}IP[/prefix]${RESET}"
printf "  %b            Local host address (/32)\n" "${MAGENTA}host${RESET}"
printf "  %b            Directly connected (ARP on interface)\n" "${BLUE}link${RESET}"
printf "  %b        Routed destination (via gateway or rule)\n" "${YELLOW}universe${RESET}"
printf "\n"
printf "  %b         Normal one-to-one traffic\n" "${GREEN}UNICAST${RESET}"
printf "  %b           Address owned by this system\n" "${GREEN}LOCAL${RESET}"
printf "  %b         Subnet broadcast address\n" "${RED}BROADCAST${RESET}"
echo
printf "\nTip:\n"
printf "  Longest-prefix match always wins.\n"
